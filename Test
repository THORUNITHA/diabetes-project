#!/bin/sh

# Load environment variables
. /apps/tml/envConfigs/checkEnv.sh

TML_BIN=/apps/tml/Allocation/processes/tmltradeloader
JAVA_HOME=/path/to/java         # Update this to the correct Java home path
CURRENT_ENV=$current_env        # Assuming current_env is set in checkEnv.sh

# Change directory to TML_BIN
cd "$TML_BIN" || { echo "Failed to change directory to $TML_BIN"; exit 1; }

PORT=22601

# Find the process using the port
TARGET_PID=$(lsof -ti :$PORT)

if [ -n "$TARGET_PID" ]; then
    echo "Stopping process on port $PORT with PID: $TARGET_PID"
    
    # Attempt a graceful shutdown using the Java command.
    "$JAVA_HOME/bin/java" -cp "${TML_BIN}/tmltradeloader-2.0.13.jar" \
        -Denv="$CURRENT_ENV" \
        com.baml.tmi.tmltradeloader.main.TmlTradeLoaderNamMain shutdown $PORT

    sleep 5

    # Check if the process is still running
    if ps -p "$TARGET_PID" > /dev/null; then
        echo "Process still running on port $PORT. Force killing..."
        kill -9 "$TARGET_PID"
    fi

    echo "Shutdown complete."
else
    echo "No process found on port $PORT."
fi
